
<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Bomb Defusal</title>
<style>
body{background:#0f0f12;color:#eee;font-family:system-ui;margin:0}
header{padding:12px;border-bottom:1px solid #222;display:flex;justify-content:space-between}
main{max-width:900px;margin:auto;padding:12px}
.card{background:#16161c;padding:12px;border-radius:12px;margin-bottom:12px}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
button,input,select,textarea{background:#1f1f28;color:#fff;border:1px solid #333;border-radius:10px;padding:10px}
.big{font-size:36px;font-weight:800}
.muted{color:#aaa}
.bad{color:#ff6b6b}
.ok{color:#7cff9b}
ul{list-style:none;padding:0}
li{border-bottom:1px solid #222;padding:6px 0}
</style>
</head>
<body>

<header>
<b>爆弾解除端末</b>
<div>
<button id="kpBtn">KPモード</button>
<button id="resetBtn">リセット</button>
</div>
</header>

<main>

<div class="card grid2">
<div>
<div class="muted">状態</div>
<div id="status"></div>
</div>
<div>
<div class="muted">残りターン</div>
<div id="turns" class="big"></div>
</div>
</div>

<div class="card">
<div id="progress"></div>
<div id="warning" class="muted"></div>
</div>

<div class="card" id="actions"></div>

<div class="card">
<ul id="log"></ul>
</div>

<h3 id="kpTitle" style="display:none">KP管理</h3>
<div class="card" id="kpPanel" style="display:none"></div>

</main>

<script>
const defaultBomb={
turns:12,
panel_password:"A-19",
screw_sequence:["TL","TR","BR","BL"],
cover_wrong_cost:1,
wires:["RED-1","BLU-1","GRN-2","YEL-2","PUR-3","RED-3","BLU-4","GRN-4","YEL-5","PUR-6"],
first_correct_wires:["RED-1","BLU-4"],
sum_target:11,
last_color:"PUR",
wire_mistakes_allowed:1
};

const state={
bomb:structuredClone(defaultBomb),
answersConfigured:true,
status:"armed",
stage:"sealed",
turnsLeft:defaultBomb.turns,
screwIndex:0,
screwsRemoved:[],
panelFailures:0,
wireCut:[],
wireMistakes:0,
log:[]
};

const KP_PASSWORD="lovesushi";
let kp=false;

const $=id=>document.getElementById(id);

const corner=c=>c==="TL"?"左上":c==="TR"?"右上":c==="BL"?"左下":"右下";

function addLog(m){state.log.unshift(new Date().toLocaleTimeString()+" "+m)}

function computeLast(){
if(!state.answersConfigured) return null;
const [a,b]=state.bomb.first_correct_wires.map(w=>Number(w.split("-")[1]));
return state.bomb.last_color+"-"+(state.bomb.sum_target-a-b);
}

function render(){
$("status").textContent=state.status+" / "+state.stage;
$("turns").textContent="T-"+state.turnsLeft;

$("progress").textContent=
state.stage==="sealed"?`ネジ ${state.screwIndex}/4`:
state.stage==="panel"?`失敗 ${state.panelFailures}/3`:
`正解 ${state.wireCut.filter(w=>[...correctSet()].includes(w)).length}/3 ミス残 ${state.bomb.wire_mistakes_allowed-state.wireMistakes}`;

$("warning").textContent=
state.stage==="cut"&&state.answersConfigured?"最後線："+computeLast():"";

if(state.status!=="armed"){
$("actions").innerHTML=state.status==="defused"?"<b class='ok'>解除成功</b>":"<b class='bad'>爆発</b>";
}else if(state.stage==="sealed")sealed();
else if(state.stage==="panel")panel();
else cut();

$("log").innerHTML=state.log.map(l=>"<li>"+l+"</li>").join("");

$("kpTitle").style.display=kp?"":"none";
$("kpPanel").style.display=kp?"":"none";
if(kp)kpRender();
}

function sealed(){
$("actions").innerHTML=["TL","TR","BL","BR"].map(p=>
`<button onclick="screw('${p}')">ネジ ${corner(p)}</button>`).join("");
}

function screw(p){
const need=state.bomb.screw_sequence[state.screwIndex];
state.turnsLeft--;
if(p===need){
state.screwIndex++;state.screwsRemoved.push(p);addLog("ネジ "+corner(p)+" 成功");
if(state.screwIndex===4)state.stage="panel";
}else{
state.turnsLeft-=state.bomb.cover_wrong_cost;
addLog("ネジ失敗");
}
if(state.turnsLeft<=0)state.status="exploded";
render();
}

function panel(){
$("actions").innerHTML=`<input id="pw"><button onclick="unlock()">解錠</button>`;
}

function unlock(){
state.turnsLeft--;
if($("pw").value===state.bomb.panel_password){
state.stage="cut";addLog("パネル解除");
}else{
state.panelFailures++;addLog("失敗");
if(state.panelFailures>=3)state.status="exploded";
}
render();
}

function correctSet(){
const s=new Set(state.bomb.first_correct_wires);
const l=computeLast();
if(l)s.add(l);
return s;
}

function cut(){
if(!state.answersConfigured){
$("actions").innerHTML="<b class='bad'>KPが答えを設定していません</b>";
return;
}
$("actions").innerHTML=state.bomb.wires.map(w=>
`<button onclick="doCut('${w}')">CUT ${w}</button>`).join("");
}

function doCut(w){
const last=computeLast();
if(w===last&&state.wireCut.length<2){state.status="exploded";render();return;}
state.wireCut.push(w);
if(!correctSet().has(w)){
state.wireMistakes++;
if(state.wireMistakes>state.bomb.wire_mistakes_allowed){state.status="exploded";}
}
if(state.wireCut.filter(x=>correctSet().has(x)).length===3){
if(state.wireCut[state.wireCut.length-1]===last)state.status="defused";
else state.status="exploded";
}
render();
}

$("kpBtn").onclick=()=>{
if(!kp){
const p=prompt("KPパスワード");
if(p===KP_PASSWORD){kp=true;addLog("KP解錠");}
}else kp=false;
render();
};

function kpRender(){
$("kpPanel").innerHTML=`
<textarea id="wires">${state.bomb.wires.join("\n")}</textarea>
<button onclick="applyWires()">ワイヤー適用（答え未設定）</button>
<hr>
<input id="f1" value="${state.bomb.first_correct_wires[0]}">
<input id="f2" value="${state.bomb.first_correct_wires[1]}">
<input id="sum" value="${state.bomb.sum_target}">
<input id="color" value="${state.bomb.last_color}">
<button onclick="applyAnswers()">答え適用</button>
`;
}

function applyWires(){
state.bomb.wires=$("wires").value.split("\n").filter(x=>x);
state.answersConfigured=false;
state.wireCut=[];
state.wireMistakes=0;
addLog("ワイヤーのみ変更");
render();
}

function applyAnswers(){
state.bomb.first_correct_wires=[$("f1").value,$("f2").value];
state.bomb.sum_target=Number($("sum").value);
state.bomb.last_color=$("color").value;
state.answersConfigured=true;
addLog("答え設定完了");
render();
}

$("resetBtn").onclick=()=>{
Object.assign(state,{
bomb:structuredClone(state.bomb),
answersConfigured:state.answersConfigured,
status:"armed",
stage:"sealed",
turnsLeft:state.bomb.turns,
screwIndex:0,
screwsRemoved:[],
panelFailures:0,
wireCut:[],
wireMistakes:0,
log:[]
});
render();
};

addLog("起動");
render();
</script>
</body>
</html>